# Pentesting MongoDB

MongoDB is a popular, open-source NoSQL database that provides high performance, high availability, and easy scalability. MongoDB stores data in BSON (Binary JSON) format, which is a binary representation of JSON-like documents. This allows for a flexible schema where documents in a collection can have varied fields. Unlike relational databases, MongoDB is a NoSQL database that doesn’t require a fixed schema, so you can insert data without first defining its structure.
- MongoDB is a cross-platform database which runs on various operating systems.
- MongoDB is a NoSQL database program. Default ports are `27017`,`27018`

## Nmap Enumeration

```bash
nmap -sV --script "mongo* and default" -p 27017 <IP>
nmap --script mongodb-info -p 27017 <target-ip>
nmap --script mongodb-databases -p 27017 <target-ip>
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```

## Shodan

- All mongodb: `"mongodb server information"`
- Search for full open mongodb servers: `"mongodb server information" -"partially enabled"`
- Only partially enable auth: `"mongodb server information" "partially enabled"`


## Metasploit

```bash
   1  auxiliary/scanner/mongodb/mongodb_login                                   normal   No     MongoDB Login Utility
   2  auxiliary/gather/mongodb_js_inject_collection_enum       2014-06-07       normal   No     MongoDB NoSQL Collection Enumeration Via Injection
   3  exploit/linux/misc/mongod_native_helper                  2013-03-24       normal   No     MongoDB nativeHelper.apply Remote Code Execution
```


# MongoDB commands:

### Login

By default mongo does not require password. 
**admin** is a common mongo database.

```bash
# Local 
mongo 
mongo --port 27017 

# Remote

mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo --host <target-ip> --port 27017 -u username -p password 
mongo "mongodb://<target-ip>:27017" 
mongo "mongodb://username:password@<target-ip>:27017/?authSource=admin"

```

### Basic MongoDB commands

```sql
# All databases
show dbs
# Current database 
db
# Switch database if it exists, or create new if not exist 
use db_name
# Collections 
show collections
#Dump the collection
db.<collection>.find()
#Number of records of the collection
db.<collection>.count()
#Find in current db the username admin
db.current.find({"username":"admin"}) 
# List users in the current database 
show users
# Create new collection in current database 
db.createCollection("users")
```

### CRUD

```sql
# Create
> db.<collection_name>.insert({id: "1", username: "admin"})
# Read
> db.<collection_name>.find()
> db.<collection_name>.findOne({"username":"michael"})
# Update
> db.<collection_name>.update({id: "1"}, {$set: {username: "king"}})
# Delete
> db.<collection_name>.remove({"name": "Micael"})
# Delete all documents
> db.<collection_name>.remove({})
```

### Operators

```sql
# $eq (Equal):
# Matches values that are equal to a specified value.
db.<collection_name>.find({age: {"$eq": 25}})
# $ne (Not Equal):
# Matches all values that are not equal to a specified value.
db.<collection_name>.find({age: {"$ne": 25}})
# $gt (Greater Than):
# Matches values that are greater than a specified value.
db.<collection_name>.find({age: {"$gt": 25}})
# $where:
# Matches documents that satisfy a JavaScript expression.
db.<collection_name>.find({$where: "this.age > 25"})
# $exists:
# Matches documents that have the specified field.
db.<collection_name>.find({age: {$exists: true}})
# $regex (Regular Expression):
# Provides regular expression capabilities for pattern matching strings in queries.
# Finds documents where 'name starts with 'A
db.<collection_name>.find({name: {$regex: /^A/}})
# $lt (Less Than):
db.<collection_name>.find({age: {"$lt": 25}})
# $gte (Greater Than or Equal):
db.<collection_name>.find({age: {"$gte": 25}})
# $lte (Less Than or Equal):
db.<collection_name>.find({age: {"$lte": 25}})
# $in (In):
db.<collection_name>.find({age: {"$in": [25, 30, 35]}})
# $nin (Not In):
db.<collection_name>.find({age: {"$nin": [25, 30, 35]}})
```



# Tools
- [mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict)
- [mongoaudit](https://github.com/stampery/mongoaudit), [mongoaudit](https://pypi.org/project/mongoaudit/)
- [NoSQLMap](https://github.com/codingo/NoSQLMap)
- [RoboMongo (Robo 3T)](https://robomongo.org/)


# Resources
- [Hacktricks](https://book.hacktricks.xyz/network-services-pentesting/27017-27018-mongodb)
- [pentest-wiki](https://github.com/nixawk/pentest-wiki/tree/master/2.Vulnerability-Assessment/Database-Assessment/mongodb)
- [How to scan for MongoDB injection vulnerabilities – and how to fix them](https://www.invicti.com/blog/docs-and-faqs/scan-fix-mongodb-injection-vulnerabilities/)
- [UNAUTHENTICATED MONGODB – ATTACK AND DEFENSE](https://www.virtuesecurity.com/kb/unauthenticated-mongodb-attack-and-defense/)
- [Pentesting in the Real World: Going Bananas with MongoDB](https://www.rapid7.com/blog/post/2016/07/28/pentesting-in-the-real-world-going-bananas-with-mongodb/)
- [MongoDB Pentesting](https://exploit-notes.hdks.org/exploit/database/mongodb-pentesting/)
  